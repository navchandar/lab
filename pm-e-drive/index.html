<!doctype html>
<html lang="en" class="h-full">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PM E-DRIVE - EV Comparison</title>
    <meta
      name="description"
      content="Compare range, efficiency, max speed, and payload capacity of electric vehicles in India."
    />
    <meta
      name="keywords"
      content="EV comparison India, Ather, Chetak, iQube, PM E-DRIVE data"
    />

    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
      rel="stylesheet"
    />

    <style type="text/tailwindcss">
      @theme {
        --color-midnight: #020617;
        --color-panel: #0f172a;
        --color-accent: #3b82f6;
      }
      [v-cloak] {
        display: none;
      }
      body {
        @apply antialiased text-[12px] flex flex-col h-full overflow-hidden bg-slate-50 dark:bg-midnight;
      }

      /* Dark Mode Select */
      select option {
        @apply bg-white text-slate-900 dark:bg-slate-800 dark:text-white;
      }

      /* Themed Loading Animation */
      .loader-pulse {
        animation: pulse-truck 1.5s infinite ease-in-out;
      }
      @keyframes pulse-truck {
        0%,
        100% {
          transform: scale(1);
          opacity: 1;
        }
        50% {
          transform: scale(1.1);
          opacity: 0.5;
        }
      }

      .mini-chart {
        position: relative;
        width: 100%;
        height: 180px;
      }
      .compact-scrollbar::-webkit-scrollbar {
        width: 4px;
      }
      .compact-scrollbar::-webkit-scrollbar-thumb {
        @apply bg-slate-300 dark:bg-slate-700 rounded-full;
      }

      .winner-card {
        @apply ring-2 ring-emerald-500 bg-emerald-500/10 text-emerald-600 dark:text-emerald-400;
      }
      .main-content {
        height: calc(100vh - 84px);
      } /* Header + Footer offset */

      /* Transitions */
      .fade-enter-active,
      .fade-leave-active {
        transition: opacity 0.3s ease;
      }
      .fade-enter-from,
      .fade-leave-to {
        opacity: 0;
      }

      .toast-enter-active,
      .toast-leave-active {
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      }
      .toast-enter-from,
      .toast-leave-to {
        transform: translateX(100%);
        opacity: 0;
      }
      /* Zoom Transitions */
      .zoom-enter-active,
      .zoom-leave-active {
        transition:
          opacity 0.3s ease,
          transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      }

      .zoom-enter-from,
      .zoom-leave-to {
        transform: scale(0.9);
        opacity: 0;
      }

      /* Prevent body scroll when image is zoomed */
      .overflow-hidden-zoom {
        overflow: hidden;
      }
    </style>
  </head>

  <body class="dark:text-slate-200">
    <div id="app" v-cloak class="flex flex-col h-full">
      <div
        v-if="loading"
        class="fixed inset-0 z-[100] bg-white dark:bg-midnight flex flex-col items-center justify-center"
      >
        <div class="loader-pulse text-blue-600 mb-4">
          <i class="fas fa-truck-fast text-6xl"></i>
        </div>
        <p class="font-black uppercase tracking-widest text-slate-400">
          Loading data...
        </p>
      </div>

      <transition-group
        name="toast"
        tag="div"
        class="fixed top-6 right-4 z-52 space-y-3 pointer-events-none"
      >
        <div
          v-for="t in toasts"
          :key="t.id"
          class="pointer-events-auto px-6 py-4 rounded-2xl shadow-2xl flex items-center gap-4 border-l-4 bg-white dark:bg-slate-800"
          :class="t.type === 'error' ? 'border-red-500' : 'border-emerald-500'"
        >
          <i
            class="fas text-xl"
            :class="t.type === 'error' ? 'fa-circle-exmark text-red-500' : 'fa-circle-check text-emerald-500'"
          ></i>
          <span class="font-bold text-sm dark:text-white">{{ t.message }}</span>
        </div>
      </transition-group>

      <header
        class="flex-shrink-0 bg-white/90 dark:bg-panel/90 backdrop-blur-md border-b border-slate-200 dark:border-slate-800 p-2 px-4 flex items-center justify-between z-50"
      >
        <div class="flex items-center gap-2">
          <i class="fas fa-bolt-lightning text-blue-600"></i>
          <h1 class="font-black uppercase tracking-tighter">
            EV <span class="text-blue-600">Compare</span>
          </h1>
        </div>
        <div class="flex items-center gap-2 flex-grow justify-end">
          <select
            v-model="filterType"
            class="bg-slate-100 dark:bg-slate-800 rounded px-2 py-1 font-bold border-none outline-none min-w-[100px]"
          >
            <option value="ALL">All EV Types</option>
            <option value="2W">ðŸ›µ 2-Wheeler</option>
            <option value="3W">ðŸ›º 3-Wheelers</option>
          </select>

          <select
            v-model="filterOEM"
            class="bg-slate-100 dark:bg-slate-800 rounded px-2 py-1 font-bold border-none outline-none min-w-[200px] md:min-w-[250px] max-w-[300px]"
          >
            <option value="ALL">All Brands</option>
            <option v-for="oem in uniqueOEMs" :key="oem" :value="oem">
              {{ formatText(oem) }}
            </option>
          </select>

          <input
            type="text"
            v-model="searchQuery"
            placeholder="Search models..."
            class="bg-slate-100 dark:bg-slate-800 rounded px-2 py-1 w-24 md:w-40 outline-none"
          />
        </div>
      </header>

      <div class="flex flex-grow overflow-hidden main-content">
        <aside
          class="w-44 md:w-60 flex-shrink-0 border-r border-slate-200 dark:border-slate-800 bg-white dark:bg-panel/50 flex flex-col"
        >
          <div
            class="p-2 border-b dark:border-slate-800 flex justify-between items-center text-[12px] font-black uppercase tracking-widest opacity-80"
          >
            <span>{{ filteredModels.length }} Models</span>
            <button
              @click="selectedModels = []"
              v-if="selectedModels.length"
              class="text-blue-600"
            >
              Clear
            </button>
          </div>
          <div
            class="flex-grow overflow-y-auto compact-scrollbar p-1 space-y-1"
          >
            <div
              v-for="m in filteredModels"
              :key="m.name"
              @click="toggleComparison(m)"
              class="p-2 rounded-lg cursor-pointer transition-all border flex items-center justify-between group relative"
              :class="isSelected(m) ? 'bg-blue-600 text-white border-blue-600 shadow-lg' : 'border-transparent hover:bg-slate-100 dark:hover:bg-slate-800'"
            >
              <div class="truncate mr-2">
                <div class="flex items-center gap-1">
                  <i
                    v-if="m.is_best_in_oem"
                    class="fas fa-star text-[5px] text-amber-400"
                    title="Top Ranked from this Brand"
                  >
                  </i>
                  <p class="font-bold truncate">{{ formatText(m.name) }}</p>
                </div>
                <p class="text-[8px] opacity-80 uppercase truncate">
                  {{ formatText(m.oem) }}
                </p>
              </div>
              <i
                class="fas fa-check-circle text-[10px]"
                :class="isSelected(m) ? 'opacity-100' : 'opacity-0'"
              ></i>
            </div>
          </div>
        </aside>

        <main class="flex-grow overflow-y-auto p-4 md:p-6 compact-scrollbar">
          <div
            v-if="selectedModels.length === 0"
            class="h-full flex flex-col items-center justify-center opacity-50 grayscale"
          >
            <i class="fas fa-chart-simple text-6xl mb-4"></i>
            <p class="font-black uppercase tracking-widest text-[10px]">
              Select models to generate benchmark
            </p>
          </div>

          <div
            v-else
            class="max-w-5xl mx-auto space-y-8 animate-in fade-in duration-500"
          >
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
              <div
                v-for="chart in chartConfigs"
                :key="chart.id"
                class="bg-white dark:bg-panel p-5 rounded-3xl border border-slate-200 dark:border-slate-800 shadow-sm transition-hover hover:shadow-lg"
              >
                <div class="flex justify-between items-center mb-4">
                  <h4
                    class="text-[10px] font-black uppercase tracking-[0.15em] text-slate-400"
                  >
                    {{ chart.label }}
                  </h4>
                  <span
                    class="text-[10px] font-mono text-blue-500 font-bold px-2 py-0.5 bg-blue-500/10 rounded"
                    >{{ chart.unit }}</span
                  >
                </div>
                <div class="mini-chart">
                  <canvas :id="chart.id"></canvas>
                </div>
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 pb-12">
              <div
                v-for="m in selectedModels"
                :key="m.name"
                class="bg-white dark:bg-panel p-6 rounded-[32px] border-2 transition-all"
                :class="isSelected(m) ? 'border-blue-500/20 shadow-xl' : 'border-transparent'"
              >
                <div class="flex justify-between items-start mb-6">
                  <h5 class="font-black text-sm leading-tight max-w-[80%]">
                    {{ formatText(m.name) }}
                  </h5>
                  <button
                    @click="toggleComparison(m)"
                    class="text-slate-300 hover:text-red-500"
                  >
                    <i class="fas fa-times-circle text-lg"></i>
                  </button>
                </div>
                <div class="space-y-2">
                  <div
                    v-for="spec in comparisonSpecs"
                    :key="spec.key"
                    class="flex justify-between items-center p-2.5 rounded-xl transition-colors"
                    :class="isBest(m, spec.key) ? 'winner-card' : 'bg-slate-50 dark:bg-slate-800/40'"
                  >
                    <span class="text-[10px] font-bold uppercase opacity-70"
                      >{{ spec.label }}</span
                    >
                    <span class="font-black flex items-center gap-1.5">
                      <i
                        v-if="isBest(m, spec.key)"
                        class="fas fa-crown text-[9px]"
                      ></i>
                      {{ m[spec.key] }}{{ spec.suffix }}
                    </span>
                  </div>
                </div>

                <div
                  class="mt-6 pt-6 border-t border-slate-100 dark:border-slate-800"
                >
                  <div
                    v-if="m.image"
                    class="relative group cursor-zoom-in overflow-hidden rounded-2xl bg-slate-50 dark:bg-slate-900 shadow-inner aspect-[4/3] flex items-center justify-center"
                    @click="zoomedImage = m.image"
                  >
                    <img
                      :src="'images/' + m.image"
                      :alt="m.name"
                      class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105"
                      @error="m.image = null"
                    />
                    <div
                      class="absolute inset-0 bg-black/20 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center"
                    >
                      <div
                        class="bg-white/20 backdrop-blur-md p-3 rounded-full text-white shadow-xl"
                      >
                        <i class="fas fa-magnifying-glass-plus text-xl"></i>
                      </div>
                    </div>
                  </div>

                  <div
                    v-else
                    class="rounded-2xl bg-slate-100/50 dark:bg-slate-800/30 aspect-[4/3] flex flex-col items-center justify-center border-2 border-dashed border-slate-200 dark:border-slate-700 select-none"
                  >
                    <i
                      class="fas fa-image text-slate-300 dark:text-slate-600 text-3xl mb-2"
                    ></i>
                    <span
                      class="text-[10px] font-black uppercase tracking-widest text-slate-400 dark:text-slate-500"
                    >
                      Image Not Found
                    </span>
                  </div>
                </div>

                <transition name="zoom">
                  <div
                    v-if="zoomedImage"
                    class="fixed inset-0 z-[200] flex items-center justify-center p-4 md:p-12 bg-slate-950/95 backdrop-blur-md"
                    @click.self="zoomedImage = null"
                  >
                    <button
                      @click="zoomedImage = null"
                      class="absolute top-6 right-6 w-10 h-10 flex items-center justify-center rounded-full bg-white/10 hover:bg-white/20 border border-white/20 text-white transition-all z-[210]"
                    >
                      <i class="fas fa-times text-xl"></i>
                    </button>

                    <img
                      :src="'images/' + zoomedImage"
                      class="max-w-full max-h-full rounded-2xl shadow-[0_0_50px_rgba(0,0,0,0.5)] border border-white/10 animate-in zoom-in-95 duration-300 pointer-events-none select-none"
                    />
                  </div>
                </transition>
              </div>
            </div>
          </div>
        </main>
      </div>

      <footer
        class="flex-shrink-0 bg-white dark:bg-panel border-t border-slate-200 dark:border-slate-800 h-10 px-4 flex items-center justify-between z-50 shadow-2xl"
      >
        <div class="flex gap-4 text-[9px] font-black uppercase tracking-widest">
          <a
            href="https://pmedrive.heavyindustries.gov.in"
            target="_blank"
            class="text-slate-400 hover:text-blue-500"
            >Official Data Portal</a
          >
          <a
            href="https://github.com/navchandar/lab/tree/main/pm-e-drive"
            target="_blank"
            class="text-slate-400 hover:text-blue-500"
            ><i class="fab fa-github mr-1"></i> Hosted on GitHub</a
          >
          <button
            @click="showDisclaimer = true"
            class="text-blue-500 hover:underline"
          >
            Disclaimer
          </button>
        </div>
        <p class="text-[9px] font-bold text-slate-400">
          Copyright &copy;
          <script>
            document.write(new Date().getFullYear());
          </script>
          Naveenchandar
        </p>
      </footer>

      <transition name="fade">
        <div
          v-if="showDisclaimer"
          class="fixed inset-0 z-[120] flex items-center justify-center p-4"
        >
          <div
            class="absolute inset-0 bg-slate-950/90 backdrop-blur-sm"
            @click="showDisclaimer = false"
          ></div>
          <div
            class="bg-white dark:bg-panel p-8 rounded-[40px] max-w-lg w-full relative z-10 border dark:border-slate-800 shadow-2xl"
          >
            <h3 class="text-3xl font-black italic tracking-tighter mb-6">
              Disclaimer
            </h3>
            <div
              class="text-[12px] space-y-5 text-slate-500 dark:text-slate-400 mb-10 leading-relaxed font-medium"
            >
              <p>
                â€¢ <strong>Source Data:</strong> This dashboard gathers aggregate
                data from the PM E-DRIVE portal. Specifications and eligibility
                status are subject to change without notice.
              </p>
              <p>
                â€¢ <strong>No Warranty:</strong> While we strive for accuracy,
                users should verify critical information (like subsidy validity
                and range) with official manufacturer documentation before
                making financial decisions.
              </p>
              <p>
                â€¢ <strong>No Liability:</strong> We provide this tool for
                comparison and information purposes only and are not responsible
                for financial decisions made based on these numbers.
              </p>
              <p>
                â€¢ <strong>Metrics Estimations:</strong> Calculated metrics
                (Payload, Real Range, Running Cost) are theoretical models based
                on real world assumptions. Actual results will vary based on
                terrain, weather, road and driving conditions.
              </p>
            </div>
            <button
              @click="showDisclaimer = false"
              class="w-full bg-blue-600 text-white py-5 rounded-2xl font-black uppercase tracking-[0.2em] text-xs active:scale-95 transition-all"
            >
              I Understand
            </button>
          </div>
        </div>
      </transition>
    </div>

    <script>
      const { createApp, ref, computed, watch, onMounted, nextTick } = Vue;

      createApp({
        setup() {
          // --- State ---
          const vehicles = ref([]);
          const loading = ref(true);
          const filterType = ref("ALL");
          const filterOEM = ref("ALL");
          const searchQuery = ref("");
          const selectedModels = ref([]);
          const showDisclaimer = ref(false);
          const toasts = ref([]);
          const chartInstances = {};
          const zoomedImage = ref(null);

          // --- Colors & Configuration ---
          const chartConfigs = [
            {
              id: "rangeChart",
              key: "est_real_world_range_km",
              label: "Real Range",
              unit: "KM",
              gradient: { start: "#3b82f6", end: "#1d4ed8" },
            }, // Blue
            {
              id: "speedChart",
              key: "max_speed_kmh",
              label: "Top Speed",
              unit: "KM/H",
              gradient: { start: "#ef4444", end: "#b91c1c" },
            }, // Red
            {
              id: "payloadChart",
              key: "payload_kg",
              label: "Payload Capacity",
              unit: "KG",
              gradient: { start: "#10b981", end: "#047857" },
            }, // Green
          ];

          const comparisonSpecs = [
            {
              key: "est_real_world_range_km",
              label: "Real Range",
              suffix: " km",
            },
            {
              key: "cost_per_100km_inr",
              label: "Running Cost",
              suffix: " â‚¹",
              reverse: true,
            },
            {
              key: "max_speed_kmh",
              label: "Top Speed",
              suffix: " km/h",
            },
            {
              key: "acceleration_ms2",
              label: "Acceleration",
              suffix: " m/sÂ²",
            },
            {
              key: "payload_kg",
              label: "Payload Capacity",
              suffix: " kg",
            },
            {
              key: "battery_kwh",
              label: "Battery Capacity",
              suffix: " kWh",
            },
            {
              key: "efficiency_reported_kwh_100km",
              label: "Efficiency",
              suffix: " kWh/100km",
              reverse: true,
            },
            {
              key: "battery_weight_kg",
              label: "Battery Weight",
              suffix: " kg",
              reverse: true,
            },
            {
              key: "battery_density_wh_kg",
              label: "Energy Density",
              suffix: " Wh/kg",
            },
          ];

          // --- Helpers ---
          function addToast(message, type = "error") {
            const id = Date.now();
            toasts.value.push({ id, message, type });
            setTimeout(
              () => (toasts.value = toasts.value.filter((t) => t.id !== id)),
              4000,
            );
          }

          // --- Text Normalizer (Title Case + Acronyms) ---
          function formatText(str) {
            if (!str) return "";
            // List of words to keep UPPERCASE
            const acronyms = [
              "TVS",
              "BMW",
              "KTM",
              "L1",
              "L2",
              "L5",
              "EV",
              "LR",
              "HR",
              "ST",
              "EX",
              "S1",
              "PRO",
              "MAX",
              "NX",
              "G1",
            ];

            return str
              .toLowerCase()
              .split(" ")
              .map((word) => {
                const upper = word.toUpperCase();
                // If it's a known acronym or contains numbers (e.g., 450X), keep uppercase
                if (acronyms.includes(upper) || /\d/.test(word)) return upper;
                // Otherwise Title Case
                return word.charAt(0).toUpperCase() + word.slice(1);
              })
              .join(" ");
          }

          // Watch for zoomedImage to toggle body scroll
          watch(zoomedImage, (val) => {
            if (val) document.body.classList.add("overflow-hidden-zoom");
            else document.body.classList.remove("overflow-hidden-zoom");
          });

          onMounted(async () => {
            try {
              const res = await fetch("data.json");
              if (!res.ok) throw new Error("Data source not found");
              vehicles.value = await res.json();
            } catch (e) {
              addToast(`Failed to load data: ${e.message}`);
            } finally {
              loading.value = false;
            }
            window.addEventListener("keydown", (e) => {
              if (e.key === "Escape") {
                zoomedImage.value = null;
                showDisclaimer.value = false;
              }
            });
          });

          // --- Computed Properties ---

          // 1. Available OEMs based on Category
          const uniqueOEMs = computed(() => {
            let list = vehicles.value;
            // If specific category is selected, filter the OEM list
            if (filterType.value !== "ALL") {
              list = list.filter((v) => v.type === filterType.value);
            }
            return [...new Set(list.map((v) => v.oem))].sort();
          });

          // 2. Filtered Models based on all inputs
          const filteredModels = computed(() => {
            const query = searchQuery.value.toLowerCase();
            return vehicles.value.filter((v) => {
              const typeMatch =
                filterType.value === "ALL" || v.type === filterType.value;
              const oemMatch =
                filterOEM.value === "ALL" || v.oem === filterOEM.value;
              const searchMatch =
                !query || v.name.toLowerCase().includes(query);
              return typeMatch && oemMatch && searchMatch;
            });
          });

          // --- Interaction Logic for Category Change
          // Logic: Update OEM list AND reset OEM selection to ALL.
          watch(filterType, () => {
            filterOEM.value = "ALL"; // Always reset OEM when Category changes
            selectedModels.value = []; // Clear charts
          });

          // --- Selection Methods ---

          function toggleComparison(m) {
            const idx = selectedModels.value.findIndex(
              (x) => x.name === m.name,
            );
            if (idx > -1) {
              selectedModels.value.splice(idx, 1);
            } else {
              if (selectedModels.value.length < 3) {
                selectedModels.value.push(m);
              } else {
                addToast("Max 3 models selected", "warning");
              }
            }
          }

          function isSelected(m) {
            return selectedModels.value.some((x) => x.name === m.name);
          }

          function isBest(m, key) {
            if (selectedModels.value.length < 2) return false;
            const spec = comparisonSpecs.find((s) => s.key === key);
            const vals = selectedModels.value.map((x) => x[key]);
            const target = spec.reverse ? Math.min(...vals) : Math.max(...vals);
            return m[key] === target;
          }

          // --- Chart Engine ---

          watch(
            selectedModels,
            async (newModels) => {
              await nextTick();
              const isDark = window.matchMedia(
                "(prefers-color-scheme: dark)",
              ).matches;
              const gridColor = isDark ? "#1e293b" : "#f1f5f9";
              const textColor = isDark ? "#94a3b8" : "#64748b";

              chartConfigs.forEach((conf) => {
                const ctx = document.getElementById(conf.id);
                if (!ctx) {
                  return;
                }

                // Clean up old chart
                if (chartInstances[conf.id]) {
                  chartInstances[conf.id].destroy();
                  delete chartInstances[conf.id];
                }

                if (!ctx || newModels.length === 0) {
                  return;
                }

                // Create Gradient
                const canvasCtx = ctx.getContext("2d");
                const gradient = canvasCtx.createLinearGradient(0, 0, 0, 400);
                gradient.addColorStop(0, conf.gradient.start);
                gradient.addColorStop(1, conf.gradient.end);

                chartInstances[conf.id] = new Chart(ctx, {
                  type: "bar",
                  data: {
                    labels: newModels.map((m) => {
                      // Smart Label Truncation for small charts
                      const formatted = formatText(m.name);
                      return formatted.length > 15
                        ? formatted.substring(0, 12) + "..."
                        : formatted;
                    }),
                    datasets: [
                      {
                        data: newModels.map((m) => m[conf.key]),
                        backgroundColor: gradient,
                        borderRadius: 6,
                        barThickness: 30,
                        maxBarThickness: 60,
                        hoverBackgroundColor: conf.gradient.start,
                      },
                    ],
                  },
                  options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: { duration: 500, easing: "easeOutQuart" },
                    plugins: {
                      legend: { display: false },
                      tooltip: {
                        backgroundColor: isDark ? "#0f172a" : "#ffffff",
                        titleColor: isDark ? "#fff" : "#000",
                        bodyColor: isDark ? "#cbd5e1" : "#334155",
                        borderColor: conf.gradient.start,
                        borderWidth: 1,
                        padding: 10,
                        titleFont: { size: 12, weight: "bold" },
                        callbacks: {
                          label: (ctx) => ` ${ctx.parsed.y} ${conf.unit}`,
                        },
                      },
                    },
                    scales: {
                      y: {
                        grid: { color: gridColor },
                        ticks: {
                          font: { size: 10, weight: "bold" },
                          color: textColor,
                          callback: (val) => val + " " + conf.unit,
                        },
                        beginAtZero: true,
                      },
                      x: {
                        grid: { display: false },
                        ticks: {
                          font: { size: 9, weight: "bold" },
                          color: textColor,
                        },
                      },
                    },
                  },
                });
              });
            },
            { deep: true },
          );

          return {
            loading,
            filterType,
            filterOEM,
            searchQuery,
            filteredModels,
            selectedModels,
            uniqueOEMs,
            showDisclaimer,
            toasts,
            toggleComparison,
            isSelected,
            isBest,
            chartConfigs,
            comparisonSpecs,
            formatText,
            zoomedImage,
          };
        },
      }).mount("#app");
    </script>
  </body>
</html>
