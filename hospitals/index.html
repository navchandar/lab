<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />

    <title>Hospital Network Map - India</title>

    <meta
      name="description"
      content="Interactive map to verify Health Insurance Network Hospitals and Excluded (Blacklisted) facilities in India. Avoid claim rejection by checking HDFC Ergo, ICICI, and other lists before admission."
    />

    <meta
      name="keywords"
      content="excluded hospitals list, health insurance blacklist, cashless hospital locator, network hospitals india, HDFC Ergo excluded hospitals, ICICI Lombard network, insurance claim rejection, IRDAI hospital list, medical insurance coverage map, GIPSA PPN network, hospital pincode checker"
    />

    <meta name="robots" content="index, follow" />
    <meta name="author" content="Naveenchandar" />

    <link rel="canonical" href="https://navchandar.github.io/lab/hospitals/" />

    <link
      rel="shortcut icon"
      href="data:image/png;base64,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"
    />

    <meta property="og:type" content="website" />
    <meta
      property="og:url"
      content="https://navchandar.github.io/lab/hospitals/"
    />
    <meta property="og:title" content="Hospital Network Map - India" />
    <meta
      property="og:description"
      content="Don't get your claim rejected. Instantly visualize In-Network (Cashless) and Excluded hospitals near you on an interactive map."
    />
    <meta
      property="og:image"
      content="https://navchandar.github.io/lab/hospitals/preview.jpg"
    />

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Hospital Network Map - India" />
    <meta
      name="twitter:description"
      content="Visual tool to find Cashless hospitals and avoid Excluded (Blacklisted) medical centers for health insurance claims in India."
    />
    <meta
      name="twitter:image"
      content="https://navchandar.github.io/lab/hospitals/preview.jpg"
    />

    <meta
      name="theme-color"
      content="#2c3e50"
      media="(prefers-color-scheme: light)"
    />
    <meta
      name="theme-color"
      content="#121212"
      media="(prefers-color-scheme: dark)"
    />
    <script type="application/ld+json">
      {
        "@context": "https://schema.org",
        "@type": "WebApplication",
        "name": "Hospital Network Map - India",
        "alternateName": "Cashless & Excluded Hospital List Visualizer",
        "url": "https://navchandar.github.io/lab/hospitals/",
        "applicationCategory": "MedicalApplication",
        "operatingSystem": "Any",
        "browserRequirements": "Requires JavaScript enabled",
        "description": "An interactive map to verify hospital network status for health insurance claims in India. Visualize cashless facility availability and identify hospitals on the GIPSA/IRDAI excluded list.",
        "offers": {
          "@type": "Offer",
          "price": "0",
          "priceCurrency": "INR",
          "availability": "https://schema.org/InStock"
        },
        "featureList": [
          "Search hospitals by Name, Pincode or City",
          "Check Cashless vs Reimbursement status",
          "Identify GIPSA PPN Network Hospitals",
          "View IRDAI Excluded Hospitals"
        ],
        "keywords": "cashless hospitals India, GIPSA network map, excluded hospitals list, health insurance network, PPN hospitals, ROHINI code search",
        "isAccessibleForFree": true
      }
    </script>

    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css"
    />

    <style>
      /* --- THEME VARIABLES --- */
      :root {
        /* Modern Slate Palette (Light) */
        --bg-color: #ffffff;
        --sidebar-bg: #ffffff;
        --text-primary: #1e293b;
        --text-secondary: #64748b;
        --border-color: #e2e8f0;
        --hover-bg: #d7ebff;
        --active-bg: #eff6ff;
        --primary-color: #0f172a;
        --accent-color: #3b82f6;
        --danger-color: #ef4444;
        --success-color: #10b981;
        --modal-overlay: rgba(15, 23, 42, 0.6);
        --modal-bg: #ffffff;
        --input-bg: #f8fafc;
        --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        --shadow-md:
          0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        --radius-sm: 6px;
        --radius-md: 8px;

        /* Popup Vars */
        --popup-bg: #ffffff;
        --popup-text: #1e293b;

        --header-bg: linear-gradient(135deg, #11274b 0%, #127bd3 100%);
        --header-text: #ffffff;
        --header-border: 1px solid var(--border-color);
      }

      .checkbox-group {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
        gap: 3px;
        padding-right: 10px;
        max-height: 75px;
        overflow-y: auto;
      }

      .checkbox-item:has(input[type="checkbox"]:checked) {
        color: var(--popup-text);
      }

      @media (prefers-color-scheme: dark) {
        :root {
          /* Modern Slate Palette (Dark) */
          --bg-color: #202124;
          --sidebar-bg: #292a2d;
          --text-primary: #f8fafc;
          --text-secondary: #94a3b8;
          --border-color: #334155;
          --hover-bg: #334155;
          --active-bg: #1e3a8a;
          --primary-color: #020617;
          --accent-color: #60a5fa;
          --danger-color: #f87171;
          --success-color: #34d399;
          --modal-overlay: rgba(0, 0, 0, 0.75);
          --modal-bg: #292a2d;
          --input-bg: #0f172a;

          /* Dark Popup Vars */
          --popup-bg: #1e293b;
          --popup-text: #f8fafc;

          --header-bg: linear-gradient(135deg, #030509 0%, #002f7c 100%);
          --header-text: #dbdbdb;
          --header-border: none;
        }
      }
    </style>

    <link rel="stylesheet" href="style.css" />
  </head>

  <body>
    <div id="toast"></div>

    <dialog id="genericModal" class="native-modal">
      <div class="modal-wrapper">
        <span class="modal-close" onclick="closeModal()">&times;</span>
        <h2 class="modal-title" id="modalTitle">Title</h2>
        <div class="modal-body" id="modalBody"></div>
      </div>
    </dialog>

    <div class="container">
      <div class="sidebar">
        <div class="header">
          <h1>Hospital Network Map</h1>
          <p>Know where to go and where not to!</p>
        </div>

        <div class="dataset-toggle">
          <button
            class="toggle-btn active"
            id="btn-network"
            onclick="loadDataset('network')"
            data-tooltip="View hospitals in-network of Insurance providers, where Cashless Treatment is eligible"
          >
            In-Network
          </button>
          <button
            class="toggle-btn"
            id="btn-excluded"
            onclick="loadDataset('excluded')"
            data-tooltip="View hospitals that are excluded/blacklisted by Insurance providers and disqualified from claims"
          >
            Excluded
          </button>
        </div>

        <div class="controls">
          <div class="search-wrapper">
            <input
              type="search"
              id="searchInput"
              class="search-box"
              placeholder="Search hospital name, city..."
              autocomplete="off"
            />
            <span class="search-clear" id="searchClear">&times;</span>
          </div>

          <span class="filter-label">Filter by Insurance Company:</span>
          <div class="checkbox-group" id="insurerFilters">
            <span class="filter-loading">Loading filters...</span>
          </div>
        </div>

        <div class="results-info">
          <span id="resultsCount">Initializing...</span>
        </div>

        <ul class="hospital-list" id="hospitalList"></ul>

        <div class="sidebar-footer">
          <span class="footer-link" onclick="openSourcesModal()">
            Sources
          </span>
          <span class="footer-link" onclick="openDisclaimerModal()">
            Disclaimer
          </span>
        </div>
      </div>

      <div id="map">
        <div id="map-loader">
          <div class="spinner"></div>
          <span
            id="map-loader-text"
            style="font-size: 0.7rem; font-weight: 600"
          >
            Updating...
          </span>
        </div>
      </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

    <script>
      /**
       * MODULE: CONFIGURATION
       * Centralized configuration for endpoints and map settings.
       */
      const CONFIG = {
        network: {
          url: "data/innetwork.json",
          color: "#2e7d32",
          label: "In-Network",
        },
        excluded: {
          url: "data/excluded.json",
          color: "#d32f2f",
          label: "Excluded",
        },
      };
      const SOURCES_URL = "data/sources.json";
      const MAP_DEFAULTS = {
        center: [22.5937, 78.9629],
        zoom: 5,
        options: { zoomControl: false },
      };

      /**
       * MODULE: STATE MANAGEMENT
       * Global state variables.
       */
      const AppState = {
        map: null,
        markersClusterGroup: null,
        tileLayer: null,
        currentType: "network",
        currentDataset: [], // Raw data from JSON
        currentFilteredData: [], // Data after search/checkbox filters

        // Lazy Loading State
        visibleItems: [], // Items currently visible in map bounds
        renderedCount: 0, // How many currently shown in sidebar
        batchSize: 30, // render 30 at a time for speed

        markerMap: {}, // Quick lookup for markers by ID
        clickedMarker: null, // Track sticky tooltip state
      };

      // --- INIT ---
      document.addEventListener("DOMContentLoaded", () => {
        MapManager.init();
        DataManager.loadDataset("network");
        UIManager.setupEventListeners();
      });

      /**
       * MODULE: MAP MANAGER
       * Handles Leaflet initialization, layers, and interactions.
       */
      const MapManager = {
        init: () => {
          // Detect Dark Mode
          const isDarkMode =
            window.matchMedia &&
            window.matchMedia("(prefers-color-scheme: dark)").matches;

          // Map Tiles Setup
          const lightTiles =
            "https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png";
          const darkTiles =
            "https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png";
          const tilesUrl = isDarkMode ? darkTiles : lightTiles;

          // Map Instantiation
          AppState.map = L.map("map", MAP_DEFAULTS.options).setView(
            MAP_DEFAULTS.center,
            MAP_DEFAULTS.zoom,
          );
          L.control.zoom({ position: "bottomright" }).addTo(AppState.map);

          // Custom Reset button Control
          const ResetControl = L.Control.extend({
            options: { position: "bottomright" },
            onAdd: function (map) {
              const container = L.DomUtil.create(
                "div",
                "leaflet-bar leaflet-control",
              );
              const btn = L.DomUtil.create(
                "a",
                "leaflet-control-reset-btn",
                container,
              );
              btn.href = "#";
              btn.title = "Reset View";
              btn.innerHTML = "⟲";
              btn.onclick = (e) => {
                L.DomEvent.preventDefault(e);
                MapManager.resetView();
              };
              return container;
            },
          });
          AppState.map.addControl(new ResetControl());

          // Layer Setup
          AppState.tileLayer = L.tileLayer(tilesUrl, {
            attribution: "&copy; OpenStreetMap &copy; CARTO",
            subdomains: "abcd",
            maxZoom: 19,
          }).addTo(AppState.map);

          AppState.markersClusterGroup = L.markerClusterGroup({
            chunkedLoading: true,
            maxClusterRadius: 45,
            showCoverageOnHover: false,
          });

          // Spiderfy logic on hover for small clusters
          AppState.markersClusterGroup.on("clustermouseover", function (a) {
            if (a.layer.getChildCount() < 10) {
              a.layer.spiderfy();
            }
          });

          AppState.map.addLayer(AppState.markersClusterGroup);

          // Event Binding
          AppState.map.on("moveend", () => UIManager.updateSidebarList(false));

          AppState.map.on("click", () => {
            AppState.clickedMarker = null;
            AppState.map.closePopup();
          });

          // Theme Listener
          window
            .matchMedia("(prefers-color-scheme: dark)")
            .addEventListener("change", (e) => {
              const newUrl = e.matches ? darkTiles : lightTiles;
              AppState.tileLayer.setUrl(newUrl);
            });
        },

        resetView: () => {
          AppState.map.flyTo(MAP_DEFAULTS.center, MAP_DEFAULTS.zoom, {
            duration: 1.5,
            easeLinearity: 0.5,
          });
        },

        renderMarkers: (data) => {
          AppState.markersClusterGroup.clearLayers();
          AppState.markerMap = {};
          const isExcluded = AppState.currentType === "excluded";
          const color = CONFIG[AppState.currentType].color;

          const markers = data
            .map((item, index) => {
              if (!item.lat || !item.lng) return null;
              if (item.lat == 0.0 || item.lng == 0.0) return null;
              item._ui_id = index;

              const marker = L.marker([item.lat, item.lng]);

              // Safe access to array
              const companyList = (
                item.excluded_by ||
                item.insurers ||
                []
              ).join(", ");
              const badgeHtml = isExcluded
                ? `<div class="badge excluded">⛔ EXCLUDED</div>`
                : `<div class="badge network">✅ IN-NETWORK</div>`;
              const titleList = isExcluded
                ? `Excluded by: ${companyList}`
                : `In-Network of: ${companyList}`;

              const popupContent = `
                      <div style="min-width:200px; font-family:inherit;">
                          ${badgeHtml}
                          <h3 style="color:${color};" class="hosp-name">
                            ${item.name}
                          </h3>
                          <p class="address">
                              ${item.address || ""}, ${item.city || ""}
                          </p>
                          <p class="pin"><strong>PIN:</strong>
                            ${item.pincode || "N/A"}
                          </p>
                          ${
                            companyList
                              ? `<div class="companylist" title="${titleList}">${companyList}</div>`
                              : ""
                          }
                      </div>
                  `;

              marker.bindPopup(popupContent);

              // Hover/Click Logic
              marker.on("mouseover", function () {
                if (AppState.clickedMarker !== this) this.openPopup();
              });
              marker.on("mouseout", function () {
                if (AppState.clickedMarker !== this) this.closePopup();
              });
              marker.on("click", function (e) {
                AppState.clickedMarker = this;
                this.openPopup();
                L.DomEvent.stopPropagation(e);
              });

              AppState.markerMap[index] = marker;
              return marker;
            })
            .filter((m) => m !== null);

          AppState.markersClusterGroup.addLayers(markers);
        },
      };

      /**
       * MODULE: DATA MANAGER
       * Handles fetching, parsing, and error state for data.
       */
      const DataManager = {
        resetState: () => {
          // CRITICAL: Clear data immediately so map moves don't show stale info
          AppState.currentDataset = [];
          AppState.currentFilteredData = [];
          AppState.markersClusterGroup.clearLayers();
          AppState.markerMap = {};
        },

        loadDataset: async (type) => {
          AppState.currentType = type;

          // Immediate Reset before loading new data
          DataManager.resetState();
          UIManager.updateToggleUI();
          UIManager.showLoading(
            true,
            `Loading ${CONFIG[type].label} Hospitals...`,
          );

          // Reset Sidebar & Filters immediately to "Loading" state
          document.getElementById("hospitalList").innerHTML = "";
          document.getElementById("resultsCount").classList.remove("error");
          document.getElementById("resultsCount").innerText = "Loading data...";
          document.getElementById("insurerFilters").innerHTML =
            '<span class="filter-loading">Loading filters...</span>';

          try {
            const response = await fetch(CONFIG[type].url);

            if (!response.ok) {
              throw new Error(`HTTP Error ${response.status}: File not found`);
            }

            AppState.currentDataset = await response.json();

            // If JSON is valid but empty array
            if (
              !Array.isArray(AppState.currentDataset) ||
              AppState.currentDataset.length === 0
            ) {
              console.warn(type + " dataset is empty!");
              AppState.currentDataset = [];
            }

            UIManager.generateCompanyFilters(AppState.currentDataset);
            UIManager.applyFilters();
          } catch (error) {
            console.error("Data Load Error:", error);
            DataManager.handleLoadError(error);
          } finally {
            UIManager.showLoading(false);
          }
        },

        handleLoadError: (error) => {
          // Update all UI components to reflect error state
          UIManager.showToast(`Failed to load data: ${error.message}`, true);

          const countLabel = document.getElementById("resultsCount");
          countLabel.innerText = "Data Unavailable";
          countLabel.classList.add("error");
          document.getElementById("hospitalList").innerHTML =
            '<li class="nodata error">No data available for this category.</li>';
          UIManager.generateCompanyFilters([]);
        },
      };

      /**
       * MODULE: UI MANAGER
       * Handles DOM updates, Sidebar, Modals, and Toasts.
       */
      const UIManager = {
        setupEventListeners: () => {
          // Network Status
          window.addEventListener("offline", () =>
            UIManager.showToast("You seem to be offline.", true),
          );
          window.addEventListener("online", () =>
            setTimeout(() => UIManager.showToast("Back online!", false), 2000),
          );

          // Search
          const searchInput = document.getElementById("searchInput");
          const searchClear = document.getElementById("searchClear");

          searchInput.addEventListener("input", () => {
            searchClear.style.display = searchInput.value ? "block" : "none";
            UIManager.applyFilters();
          });

          searchClear.addEventListener("click", () => {
            searchInput.value = "";
            searchClear.style.display = "none";
            UIManager.applyFilters();
            searchInput.focus();
            MapManager.resetView();
          });

          // Modal Close
          document
            .getElementById("genericModal")
            .addEventListener("click", (e) => {
              if (e.target.id === "genericModal") UIManager.closeModal();
            });

          // --- Infinite Scroll Listener ---
          const listContainer = document.getElementById("hospitalList");
          listContainer.addEventListener("scroll", () => {
            // Load next batch when user scrolls near bottom
            if (
              listContainer.scrollTop + listContainer.clientHeight >=
              listContainer.scrollHeight - 100
            ) {
              UIManager.renderNextBatch();
            }
          });

          // --- Event Delegation (Click) ---
          listContainer.addEventListener("click", (e) => {
            const li = e.target.closest(".hospital-item");
            if (!li) return;

            const id = li.dataset.id;
            const item = AppState.visibleItems.find((x) => x._ui_id == id);
            if (!item) return;

            const marker = AppState.markerMap[item._ui_id];
            if (marker) {
              AppState.markersClusterGroup.zoomToShowLayer(marker, () => {
                setTimeout(() => marker.openPopup(), 100);
              });

              if (window.innerWidth <= 768) {
                document
                  .getElementById("map")
                  .scrollIntoView({ behavior: "smooth" });
              }

              document
                .querySelectorAll(".hospital-item")
                .forEach((el) => el.classList.remove("active"));
              li.classList.add("active");
            }
          });

          // --- Event Delegation (Hover) ---
          listContainer.addEventListener("mouseover", (e) => {
            const li = e.target.closest(".hospital-item");
            if (!li) return;
            const id = li.dataset.id;

            const marker = AppState.markerMap[id];
            if (marker) {
              const visibleParent =
                AppState.markersClusterGroup.getVisibleParent(marker);
              if (visibleParent && visibleParent !== marker) {
                if (visibleParent.getChildCount() < 10)
                  visibleParent.spiderfy();
              }
              const icon = marker.getElement();
              if (icon) icon.classList.add("marker-jump");
            }
          });

          listContainer.addEventListener("mouseout", (e) => {
            const li = e.target.closest(".hospital-item");
            if (!li) return;
            const id = li.dataset.id;
            const marker = AppState.markerMap[id];
            if (marker) {
              const icon = marker.getElement();
              if (icon) icon.classList.remove("marker-jump");
            }
          });
        },

        updateToggleUI: () => {
          document
            .getElementById("btn-network")
            .classList.toggle("active", AppState.currentType === "network");
          document
            .getElementById("btn-excluded")
            .classList.toggle("active", AppState.currentType === "excluded");
        },

        generateCompanyFilters: (data) => {
          const container = document.getElementById("insurerFilters");
          container.innerHTML = "";
          if (!data || data.length === 0) {
            container.innerHTML = '<span class="filter-loading">None</span>';
            return;
          }

          const companies = new Set();
          data.forEach((item) => {
            const list =
              item.excluded_by ||
              item.insurers ||
              (item.company ? [item.company] : []);
            if (Array.isArray(list)) list.forEach((c) => companies.add(c));
          });

          if (companies.size === 0) {
            container.innerHTML = '<span class="filter-loading">None</span>';
            return;
          }

          // sort the company list alphabetically
          const sortedCompanies = Array.from(companies).sort((a, b) =>
            a.localeCompare(b),
          );

          sortedCompanies.forEach((company) => {
            const wrapper = document.createElement("label");
            wrapper.className = "checkbox-item";
            const checkbox = document.createElement("input");
            checkbox.type = "checkbox";
            checkbox.value = company;
            checkbox.checked = true;
            checkbox.addEventListener("change", UIManager.applyFilters);
            wrapper.appendChild(checkbox);
            wrapper.appendChild(document.createTextNode(company));
            container.appendChild(wrapper);
          });
        },

        applyFilters: () => {
          // If dataset is empty, skip logic but ensure map is cleared
          if (!AppState.currentDataset.length) {
            AppState.currentFilteredData = [];
            MapManager.renderMarkers([]);
            UIManager.updateSidebarList(true);
            return;
          }

          const searchText = document
            .getElementById("searchInput")
            .value.toLowerCase();
          const checkboxes = document.querySelectorAll(
            '#insurerFilters input[type="checkbox"]',
          );

          const selectedCompanies =
            checkboxes.length > 0
              ? Array.from(checkboxes)
                  .filter((cb) => cb.checked)
                  .map((cb) => cb.value)
              : null;

          AppState.currentFilteredData = AppState.currentDataset.filter(
            (item) => {
              // Search Filter
              const searchStr =
                `${item.name} ${item.address} ${item.city} ${item.pincode}`.toLowerCase();
              if (searchText && !searchStr.includes(searchText)) return false;

              // Company Filter
              const itemCompanies =
                item.excluded_by ||
                item.insurers ||
                (item.company ? [item.company] : []);
              if (selectedCompanies && itemCompanies.length > 0) {
                return itemCompanies.some((c) => selectedCompanies.includes(c));
              }
              return true;
            },
          );

          MapManager.renderMarkers(AppState.currentFilteredData);
          UIManager.updateSidebarList(true);
        },

        // --- LAZY LOADING SIDEBAR ---
        updateSidebarList: (resetScroll = false) => {
          const listContainer = document.getElementById("hospitalList");
          const countLabel = document.getElementById("resultsCount");

          if (resetScroll) listContainer.scrollTop = 0;

          // Filter visible items based on Map Bounds
          if (
            !AppState.currentFilteredData ||
            AppState.currentFilteredData.length === 0
          ) {
            AppState.visibleItems = [];
          } else {
            const bounds = AppState.map.getBounds();
            AppState.visibleItems = AppState.currentFilteredData.filter(
              (item) => {
                if (!item.lat || !item.lng) return false;
                if (item.lat == 0.0 || item.lng == 0.0) return false;
                return bounds.contains(L.latLng(item.lat, item.lng));
              },
            );
          }

          // Update Counts
          if (AppState.visibleItems.length === 0) {
            countLabel.innerText =
              AppState.currentDataset.length > 0
                ? "No Matches in View"
                : "No Data Found";
            countLabel.classList.add("error");
            listContainer.innerHTML = "";
            return;
          }

          countLabel.classList.remove("error");
          countLabel.innerText = `Showing ${AppState.visibleItems.length} locations in view`;

          // Reset Lazy Load State
          AppState.renderedCount = 0;
          listContainer.innerHTML = "";

          // Render Initial Batch
          UIManager.renderNextBatch();
        },

        renderNextBatch: () => {
          if (AppState.renderedCount >= AppState.visibleItems.length) return;

          const listContainer = document.getElementById("hospitalList");
          const nextBatch = AppState.visibleItems.slice(
            AppState.renderedCount,
            AppState.renderedCount + AppState.batchSize,
          );

          // DocumentFragment prevents layout thrashing
          const fragment = document.createDocumentFragment();
          const isExcluded = AppState.currentType === "excluded";

          nextBatch.forEach((item) => {
            const li = document.createElement("li");
            li.className = "hospital-item";
            li.dataset.id = item._ui_id; // Store ID for delegation

            const companyList = (item.excluded_by || item.insurers || []).join(
              ", ",
            );
            const badgeLabel = isExcluded ? "Excluded By" : "In-Network";
            const badgeClass = isExcluded ? "excluded" : "network";
            const titleText = `${badgeLabel}: ${companyList}`;
            const location = `${item.city ? item.city + " - " : ""}${
              item.pincode ? item.pincode : ""
            }`;

            li.innerHTML = `
              <span class="h-name">${item.name}</span>
              <span class="h-loc">${location}</span>
            <span class="badge ${badgeClass} badge-truncate" title="${titleText}">${badgeLabel}: ${companyList}</span>
          `;
            fragment.appendChild(li);
          });

          listContainer.appendChild(fragment);
          AppState.renderedCount += nextBatch.length;
        },

        // --- UTILS ---
        showLoading: (show, text) => {
          const mapLoader = document.getElementById("map-loader");
          const listContainer = document.getElementById("hospitalList");
          const countLabel = document.getElementById("resultsCount");

          if (show) {
            // Show Map Overlay
            if (mapLoader) {
              document.getElementById("map-loader-text").innerText = text;
              mapLoader.style.display = "flex";
            }
          } else {
            // Hide Map Overlay
            if (mapLoader) mapLoader.style.display = "none";
            if (listContainer.querySelector(".skeleton-loader")) {
              listContainer.innerHTML = "";
            }
          }
        },

        showToast: (msg, isError) => {
          const t = document.getElementById("toast");
          t.innerText = msg;
          t.className = isError ? "show error" : "show";
          setTimeout(
            () => (t.className = t.className.replace("show", "")),
            5000,
          );
        },

        // --- MODALS ---
        openModal: (title, htmlContent) => {
          const dialog = document.getElementById("genericModal");
          document.getElementById("modalTitle").innerText = title;
          document.getElementById("modalBody").innerHTML = htmlContent;

          if (typeof dialog.showModal === "function") {
            dialog.showModal();
            document.getElementById("modalTitle").scrollIntoView();
            document.getElementById("modalTitle").focus();
          } else {
            alert("Browser version doesnt support Dialog windows.");
          }
        },

        closeModal: () => {
          document.getElementById("genericModal").close();
        },

        openDisclaimerModal: () => {
          const content = `
                  <h3>Informational Purpose Only:</h3>
                  <p>This repository, the associated software, and the visualized data are intended strictly for educational and informational purposes. This project is not affiliated with, endorsed by, or representative of any insurance company, regulatory body (such as IRDAI), or healthcare institution.</p>

                  <h3>No Warranty of Accuracy:</h3>
                  <p>While every effort is made to ensure the data is accurate, the source documents (PDFs) are subject to change without notice. The developers make no representations or warranties of any kind, express or implied, about the completeness, accuracy, reliability, suitability, or availability of the data. Data latency may occur; latitude/longitude coordinates may be inaccurate; the official list on the insurer's website may differ from the data presented here.</p>

                  <h3>Limitation of Liability:</h3>
                  <p>In no event will the developers or contributors be liable for any loss or damage including without limitation, indirect or consequential loss or damage, or any financial loss arising from the use of this data. A decision to seek medical treatment at any specific facility is the sole responsibility of the individual.</p>

                  <h3>Mandatory Verification:</h3>
                  <p>Users are explicitly advised to independently verify the current status of any hospital directly with their specific insurance provider or Third Party Administrator (TPA) prior to admission. The official policy document and the insurer’s real-time confirmation serve as the final authority on insurance coverage.</p>
                  <p><strong>Always inform your insurer before admission.</strong></p>
                  <p>
                License:
                <a
                  href="https://github.com/navchandar/lab/blob/main/LICENSE"
                  target="_blank"
                  >GNU GPLv3
                </a>
                | Report bugs via
                <a href="https://github.com/navchandar/lab/issues" target="_blank"
                  >GitHub
                </a>
              </p>
              <div class="modal-footer">
                <button class="btn-close-modal" onclick="closeModal()">Understood</button>
              </div>
              `;
          UIManager.openModal("Legal Disclaimer", content);
        },

        openSourcesModal: async () => {
          UIManager.openModal("Data Sources", "<p>Loading sources...</p>");
          try {
            const response = await fetch(SOURCES_URL);
            if (!response.ok) throw new Error("Sources file missing");
            const data = await response.json();

            let html = `
                      <p>The data visualized here is gathered and parsed from the following sources:</p>
                      <table class="source-table">
                          <thead>
                              <tr>
                                  <th>Company</th>
                                  <th>In‑Network</th>
                                  <th>Excluded</th>
                              </tr>
                          </thead>
                          <tbody>
                  `;
            data.forEach((row) => {
              const makeLink = (url) =>
                url ? `<a href="${url}" target="_blank">Link</a>` : "-";
              html += `<tr>
                          <td>${row.company}</td>
                          <td>${makeLink(row.network_url)}</td>
                          <td>${makeLink(row.excluded_url)}</td>
                      </tr>`;
            });
            html += `</tbody></table>`;
            document.getElementById("modalBody").innerHTML = html;
          } catch (e) {
            document.getElementById("modalBody").innerHTML =
              `<p class="error">Could not load sources.</p>`;
          }
        },
      };

      // Expose globals
      window.loadDataset = DataManager.loadDataset;
      window.openDisclaimerModal = UIManager.openDisclaimerModal;
      window.openSourcesModal = UIManager.openSourcesModal;
      window.closeModal = UIManager.closeModal;
      window.resetMapView = MapManager.resetView;
    </script>
  </body>
</html>
